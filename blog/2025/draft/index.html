<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> setting up a wireguard vpn client on linux | Joshua A. Rothe </title> <meta name="author" content="Joshua A. Rothe"> <meta name="description" content="guide for configuring a client-side linux (debian) system for wireguard vpn, automating network settings on both home and away networks"> <meta name="keywords" content="FPGA, SystemVerilog, VHDL, embedded systems, signal processing, machine learning, CNNs, electrical engineering"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link defer href="/assets/css/bootstrap-toc.min.css?6f5af0bb9aab25d79b2448143cbeaa88" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://portfolio.rothellc.com/blog/2025/draft/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Joshua</span> A. Rothe </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="row"> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">setting up a wireguard vpn client on linux</h1> <p class="post-meta"> Created on March 26, 2025 </p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/linux"> <i class="fa-solid fa-hashtag fa-sm"></i> linux</a>   <a href="/blog/tag/vpn"> <i class="fa-solid fa-hashtag fa-sm"></i> vpn</a>   <a href="/blog/tag/wireguard"> <i class="fa-solid fa-hashtag fa-sm"></i> wireguard</a>   <a href="/blog/tag/pihole"> <i class="fa-solid fa-hashtag fa-sm"></i> pihole</a>   <a href="/blog/tag/devops"> <i class="fa-solid fa-hashtag fa-sm"></i> devops</a>   ·   <a href="/blog/category/linux"> <i class="fa-solid fa-tag fa-sm"></i> linux</a>   <a href="/blog/category/devops"> <i class="fa-solid fa-tag fa-sm"></i> devops</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Setting up a WireGuard VPN for privacy and security involves setting up both server and client side systems. This guide explains how to set up a client side Linux system - with or without <a href="https://pi-hole.net/" rel="external nofollow noopener" target="_blank">Pi-hole DNS filtering</a> on the home network - and then configure the system so that WireGuard settings will switch depending on if the client system is on the home network or not. This is necessary because the WireGuard client will ruin your network connection if you are on your home network, and there is no need to manually switch your VPN client on and off when automation exists.</p> <p>Guide assumes a WireGuard VPN server is set up, and port forwarding is configured on the home router. Guide is also written for Linux Mint - while this should also work for most Debian systems, you may need to modify some filepaths depending on your distro.</p> <h2 id="background">Background</h2> <h2 id="prerequesites">Prerequesites</h2> <h2 id="client-setup">Client Setup</h2> <h3 id="ssh-key-generation">SSH Key Generation</h3> <p>This should be familiar (for general server access, not WireGuard-specific handshakes), but direction is provided below just in case. On the client, run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen <span class="nt">-t</span> ed25519 <span class="nt">-C</span> <span class="s2">"your-email@example.com"</span>
</code></pre></div></div> <p>Hit enter twice - use default location and no passkey (unless you really want one).</p> <p>There are two ways to copy your key to the server, the Easy Way and the More Likely Way.</p> <hr> <div class="row"> <div class="col-md-6"> <h4 id="the-easy-way">The Easy Way:</h4> <p>The easy way only works if your client can access the server. Since we are generating keys, you should probably have password authentication enabled for SSH. In case you forgot, you modify these lines in <code class="language-plaintext highlighter-rouge">/etc/ssh/sshd_config</code>:</p> <div class="language-bash highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>PasswordAuthentication no
PubkeyAuthentication <span class="nb">yes
</span>PermitRootLogin no
</code></pre></div> </div> <p>Then on the client side you can simply run:</p> <div class="language-bash highlighter-rouge"> <div class="highlight"><pre class="highlight"><code>ssh-copy-id username@server-ip
</code></pre></div> </div> </div> <div class="col-md-6"> <h4 id="the-more-likely-way">The More Likely Way:</h4> <p>Run this on the client:</p> <div class="language-bash highlighter-rouge"> <div class="highlight"><pre class="highlight"><code><span class="nb">cat</span> ~/.ssh/id_ed25519.pub
</code></pre></div> </div> <p>Get this clipboard item to the server however you like, probbaly using another system that does have SSH access, and append it to <code class="language-plaintext highlighter-rouge">~/.ssh/authorized_keys</code>.</p> </div> </div> <hr> <h3 id="installation">Installation</h3> <p>Run on the client:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt update
<span class="nb">sudo </span>apt <span class="nb">install </span>wireguard resolvconf
</code></pre></div></div> <p>Once that is done, generate WireGuard keys (these are different than SSH keys - the former are needed to access the WireGuard server at all for configuration):</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd</span> /etc/wireguard
<span class="nb">sudo umask </span>077
<span class="nb">sudo </span>wg genkey | <span class="nb">sudo tee </span>privatekey | <span class="nb">sudo </span>wg pubkey | <span class="nb">sudo tee </span>publickey
</code></pre></div></div> <p>Next, create the WireGuard config file on your client using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/wireguard/wg0.conf
</code></pre></div></div> <p>And insert:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Interface]
PrivateKey = # Paste the contents of /etc/wireguard/privatekey here
Address = 10.0.0.2/24
DNS = 1.1.1.1

[Peer]
PublicKey = # Your server's public key goes here.
Endpoint = your-server-ip:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
</code></pre></div></div> <p>Note that you have three items to fill in above. You will need the PublicKey from the server, not from what you have here on the client. So hold off on that for now.</p> <p>Private key on the client can be acquired using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cat</span> /etc/wireguard/privatekey
</code></pre></div></div> <p>The public key on the client (which will be needed on the server) can be acquired using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo cat</span> /etc/wireguard/publickey
</code></pre></div></div> <p>Now SSH into the WireGuard server and edit the WireGuard config using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/wireguard/wg0.conf
</code></pre></div></div> <p>Append the following to the file:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Peer]
PublicKey = # Paste your client's public key here.
AllowedIPs = 10.0.0.2/32
</code></pre></div></div> <p>For <code class="language-plaintext highlighter-rouge">AllowedIPs</code>, you will need to increment the 2. For my setup, the server was .1, and I had two previous clients taking up .2 and .3, so I appended it as .4.</p> <p>Back on the client, edit the client’s WireGuard config using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/wireguard/wg0.conf
</code></pre></div></div> <p>Remember how we didn’t have the server’s public key last time? Fix that now:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Interface]
PrivateKey = # Paste(d) the contents of /etc/wireguard/privatekey here
Address = 10.0.0.2/24
DNS = 1.1.1.1

[Peer]
PublicKey = # Your server's public key goes here.
Endpoint = your-server-ip:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
</code></pre></div></div> <p>Three items to check, above. Make sure the <code class="language-plaintext highlighter-rouge">Address</code> on your client side matches <code class="language-plaintext highlighter-rouge">AllowedIps</code> on the server side.</p> <h3 id="dual-wireguard-configurations">Dual Wireguard Configurations</h3> <p>If you start WireGuard on your home network now, it will fail. You need to configure something that will turn it off when you are on your home network. Fortunately, we have good tools for this.</p> <p>On your client side, run:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo cp /etc/wireguard/wg0.conf /etc/wireguard/wg0-away.conf
sudo cp /etc/wireguard/wg0.conf /etc/wireguard/wg0-home.conf
</code></pre></div></div> <p>Create the home configuration using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/wireguard/wg0-home.conf
</code></pre></div></div> <p>The only change you need to make below is to AllowedIPs: <code class="language-plaintext highlighter-rouge">10.0.0.0/24</code> is critical here, and target your Pi-Hole for the DNS server if you have a Pi-Hole routing DNS traffic on your home network. Also don’t forget to adjust <code class="language-plaintext highlighter-rouge">Address</code> if needed.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Interface]
PrivateKey = # Your laptop's private key.
Address = 10.0.0.2/32
DNS = 1.1.1.1 # Or 192.168.1.xxx for Pi-Hole.

[Peer]
PublicKey = # Your server's public key.
Endpoint = your-server-local-ip:51820
AllowedIPs = your-local-ip/24
PersistentKeepalive = 25
</code></pre></div></div> <p>Away config should be edited using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/wireguard/wg0-away.conf
</code></pre></div></div> <p>And should contain:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Interface]
PrivateKey = # Your laptop's private key.
Address = 10.0.0.2/32
DNS = 1.1.1.1 # Or 192.168.1.xxx for Pi-Hole.

[Peer]
PublicKey = # Your server's public key.
Endpoint = your-server-external-ip:51820
AllowedIPs = 0.0.0.0/0
PersistentKeepalive = 25
</code></pre></div></div> <p>Note for above, you need your server’s external IP. This will be your home router’s IP, port forwarded to your VPN server. This was likely set up when the WIreGuard server was set up, and you only need a service like <a href="https://whatismyip.com" rel="external nofollow noopener" target="_blank">this</a> to check your external IP.</p> <p>These two <code class="language-plaintext highlighter-rouge">wg0-*</code> scripts will replace wg0.conf dynamically depending on what network the client is on. This will be triggered by the detection script, which we will now build.</p> <h3 id="detection-script">Detection Script</h3> <p>Run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/NetworkManager/dispatcher.d/99-wireguard-auto
</code></pre></div></div> <p>Add the following, adjusting the <code class="language-plaintext highlighter-rouge">HOME_*</code> values as needed:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nv">INTERFACE</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">ACTION</span><span class="o">=</span><span class="nv">$2</span>

<span class="c"># Filter out interfaces we don't care about (loopback, virtual bridges, docker intfcs, bridges.</span>
<span class="k">case</span> <span class="s2">"</span><span class="nv">$INTERFACE</span><span class="s2">"</span> <span class="k">in
    </span>lo|virbr<span class="k">*</span><span class="p">|</span>docker<span class="k">*</span><span class="p">|</span>br-<span class="k">*</span><span class="p">)</span>
        <span class="nb">exit </span>0
        <span class="p">;;</span>
<span class="k">esac</span>

<span class="nv">LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/wireguard-auto.log"</span>

log_message<span class="o">()</span> <span class="o">{</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">date</span><span class="si">)</span><span class="s2">: [</span><span class="nv">$INTERFACE</span><span class="s2">/</span><span class="nv">$ACTION</span><span class="s2">] </span><span class="nv">$1</span><span class="s2">"</span> | <span class="nb">tee</span> <span class="nt">-a</span> <span class="s2">"</span><span class="nv">$LOG_FILE</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># Only act on interface up/down events for primary connections.</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$ACTION</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"up"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$ACTION</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"down"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exit </span>0
<span class="k">fi</span>

<span class="c"># Skip if this is the WireGuard interface itself.</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$INTERFACE</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"wg0"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exit </span>0
<span class="k">fi

</span>log_message <span class="s2">"Network change detected on </span><span class="nv">$INTERFACE</span><span class="s2">"</span>

<span class="c"># Let network settle.</span>
<span class="nb">sleep </span>2

<span class="c"># Configuration. Change these as needed.</span>
<span class="nv">HOME_NETWORK_GATEWAY</span><span class="o">=</span><span class="s2">"192.168.1.1"</span> <span class="c"># Router's IP.</span>
<span class="nv">HOME_WIREGUARD_SERVER</span><span class="o">=</span><span class="s2">"192.168.1.114"</span> <span class="c"># WireGuard server IP.</span>
<span class="nv">WG_INTERFACE</span><span class="o">=</span><span class="s2">"wg0"</span>

is_home_network<span class="o">()</span> <span class="o">{</span>
    <span class="c"># Check if home gateway is reachable.</span>
    <span class="k">if </span>ping <span class="nt">-c</span> 1 <span class="nt">-W</span> 3 <span class="s2">"</span><span class="nv">$HOME_NETWORK_GATEWAY</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then</span>
        <span class="c"># Double-check by pinging WireGuard server directly.</span>
        <span class="k">if </span>ping <span class="nt">-c</span> 1 <span class="nt">-W</span> 3 <span class="s2">"</span><span class="nv">$HOME_WIREGUARD_SERVER</span><span class="s2">"</span> <span class="o">&gt;</span>/dev/null 2&gt;&amp;1<span class="p">;</span> <span class="k">then</span>
            <span class="c"># Triple-check by seeing if our IP is in the home range.</span>
            <span class="nv">local_ip</span><span class="o">=</span><span class="si">$(</span>ip route get 8.8.8.8 2&gt;/dev/null | <span class="nb">awk</span> <span class="s1">'{print $7; exit}'</span><span class="si">)</span>
            <span class="k">if</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$local_ip</span><span class="s2">"</span> <span class="o">=</span>~ ^192<span class="se">\.</span>168<span class="se">\.</span>1<span class="se">\.</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
                return </span>0 <span class="c"># Home.</span>
            <span class="k">fi
        fi
    fi
    return </span>1 <span class="c"># Away.</span>
<span class="o">}</span>

get_wg_status<span class="o">()</span> <span class="o">{</span>
    <span class="k">if </span>systemctl is-active <span class="nt">--quiet</span> wg-quick@wg0<span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"active"</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s2">"inactive"</span>
    <span class="k">fi</span>
<span class="o">}</span>

copy_config<span class="o">()</span> <span class="o">{</span>
    <span class="nb">local source</span><span class="o">=</span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$source</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">cp</span> <span class="s2">"</span><span class="nv">$source</span><span class="s2">"</span> /etc/wireguard/wg0.conf
        log_message <span class="s2">"Copied </span><span class="nv">$source</span><span class="s2"> to wg0.conf"</span>
        <span class="k">return </span>0
    <span class="k">else
        </span>log_message <span class="s2">"ERROR: </span><span class="nv">$source</span><span class="s2"> not found!"</span>
        <span class="k">return </span>1
    <span class="k">fi</span>
<span class="o">}</span>

<span class="c"># Only proceed if network connection is present.</span>
<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$ACTION</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"up"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    if </span>is_home_network<span class="p">;</span> <span class="k">then
        </span>log_message <span class="s2">"Detected home network."</span>
        <span class="nv">current_status</span><span class="o">=</span><span class="si">$(</span>get_wg_status<span class="si">)</span>
        
        <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$current_status</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"active"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="c"># Check if using away config (away config has AllowedIPs = 0.0.0.0/0).</span>
            <span class="k">if </span><span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"AllowedIPs = 0.0.0.0/0"</span> /etc/wireguard/wg0.conf 2&gt;/dev/null<span class="p">;</span> <span class="k">then
                </span>log_message <span class="s2">"Switching to home VPN config."</span>
                systemctl stop wg-quick@wg0
                <span class="k">if </span>copy_config <span class="s2">"/etc/wireguard/wg0-home.conf"</span><span class="p">;</span> <span class="k">then
                    </span>systemctl start wg-quick@wg0
                <span class="k">fi
            else
                </span>log_message <span class="s2">"Already using home VPN config."</span>
            <span class="k">fi
        else
            </span>log_message <span class="s2">"Starting home VPN config."</span>
            <span class="k">if </span>copy_config <span class="s2">"/etc/wireguard/wg0-home.conf"</span><span class="p">;</span> <span class="k">then
                </span>systemctl start wg-quick@wg0
            <span class="k">fi
        fi
    else
        </span>log_message <span class="s2">"Detected external network."</span>
        <span class="nv">current_status</span><span class="o">=</span><span class="si">$(</span>get_wg_status<span class="si">)</span>
        
        <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$current_status</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"active"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="c"># Check if we're using the home config (home config has restricted AllowedIPs).</span>
            <span class="k">if </span><span class="nb">grep</span> <span class="nt">-q</span> <span class="s2">"AllowedIPs = 192.168.1.0/24"</span> /etc/wireguard/wg0.conf 2&gt;/dev/null<span class="p">;</span> <span class="k">then
                </span>log_message <span class="s2">"Switching to away VPN config."</span>
                systemctl stop wg-quick@wg0
                <span class="k">if </span>copy_config <span class="s2">"/etc/wireguard/wg0-away.conf"</span><span class="p">;</span> <span class="k">then
                    </span>systemctl start wg-quick@wg0
                <span class="k">fi
            else
                </span>log_message <span class="s2">"Already using away VPN config."</span>
            <span class="k">fi
        else
            </span>log_message <span class="s2">"Starting away VPN config."</span>
            <span class="k">if </span>copy_config <span class="s2">"/etc/wireguard/wg0-away.conf"</span><span class="p">;</span> <span class="k">then
                </span>systemctl start wg-quick@wg0
            <span class="k">fi
        fi
    fi
elif</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$ACTION</span><span class="s2">"</span> <span class="o">=</span> <span class="s2">"down"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c"># Uncomment the next line if wireguard should stop when network goes down.</span>
    <span class="c"># systemctl stop wg-quick@wg0</span>
    log_message <span class="s2">"Network disconnected."</span>
<span class="k">fi

</span><span class="nb">exit </span>0
</code></pre></div></div> <p>Once complete, make it executable:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo chmod</span> +x /etc/NetworkManager/dispatcher.d/99-wireguard-auto
</code></pre></div></div> <p>Then, add the following (adjust DNS IP ad needed) using:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>vim /etc/NetworkManager/dispatcher.d/99-wireguard-dns.sh
</code></pre></div></div> <p>Add:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#!/bin/bash

INTERFACE=$1
ACTION=$2

if [[ "$INTERFACE" == "wg0" &amp;&amp; "$ACTION" == "up" ]]; then
    # Set Pi-hole as DNS server for WireGuard interface.
    resolvectl dns wg0 192.168.1.223 # Change! Pi-Hole DNS address or 1.1.1.1 1.0.0.1 (Cloudflare) or 9.9.9.9 149.112.112.112 (Quad9)
    resolvectl domain wg0 "~."
    
    # Remove default route from WiFi interface to prioritize VPN DNS.
    resolvectl default-route &lt;replace-me&gt; false
    
    # Ensure only VPN has default route for DNS.
    resolvectl default-route wg0 true
    
    # Flush DNS cache to apply changes.
    resolvectl flush-caches
    
    logger "WireGuard DNS configured: Pi-hole via VPN with WiFi DNS disabled."
fi
</code></pre></div></div> <p>To know what to enter in <code class="language-plaintext highlighter-rouge">&lt;replace-me&gt;</code>, run <code class="language-plaintext highlighter-rouge">ip link show</code>. You need your actual WiFI interface name.</p> <p>Make it executable:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sudo chmod +x /etc/NetworkManager/dispatcher.d/99-wireguard-dns.sh
</code></pre></div></div> <p>To finalize, restart WireGuard on both machines. For the server first, run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl restart wg-quick@wg0
</code></pre></div></div> <p>For the client, run:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>resolvectl default-route wlp4s0 <span class="nb">false
sudo </span>systemctl restart wg-quick@wg0
</code></pre></div></div> <p>This restarts WireGuard and fixes the initial VPN prioritization issue. Some Linux queries might go through your ISP’s DNS instead of the proper tunnel due to how systemd-resolve handles queries.</p> <h3 id="troubleshooting">Troubleshooting</h3> <p>Check that everything is running properly. If Pi-Hole is running, execute the following to verify that it is blocking ad servers (skip if no Pi-Hole is involved):</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nslookup doubleclick.net
nslookup googleadservices.com
</code></pre></div></div> <p>With Pi-Hole it should return <code class="language-plaintext highlighter-rouge">0.0.0.0</code>.</p> <h4 id="if-dns-is-not-working-with-pi-hole">If DNS is not working with Pi-Hole</h4> <p>Check if Pi-hole is reachable:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ping 192.168.1.223
</code></pre></div></div> <p>Verify the DNS script ran:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>journalctl <span class="nt">-u</span> NetworkManager <span class="nt">-f</span>
</code></pre></div></div> <p>Restart systemd-resolved:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>systemctl restart systemd-resolved
</code></pre></div></div> <h4 id="vpn-connects-but-no-internet">VPN connects, but no internet</h4> <p>Check routing:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ip route show
</code></pre></div></div> </div> </article> </div> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Joshua A. Rothe. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script defer src="/assets/js/bootstrap-toc.min.js?c82ff4de8b0955d6ff14f5b05eed7eb6"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-PP9RJ8XDYC"></script> <script defer src="/assets/js/google-analytics-setup.js"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>